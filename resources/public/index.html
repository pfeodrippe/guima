<body style="background-color: #EEEEEE">
  <script src="vendors/codemirror/lib/codemirror.js"></script>
  <script src="vendors/codemirror/lib/closebrackets.js"></script>
  <link rel="stylesheet" href="vendors/codemirror/lib/codemirror.css">
  <script src="vendors/codemirror/mode/ruby/ruby.js"></script>

  <style>.bmc-button img{height: 34px !important;width: 35px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{padding: 7px 15px 7px 10px !important;line-height: 35px !important;height:51px !important;text-decoration: none !important;;color:#000000 !important;background-color:#FFDD00 !important;border-radius: 5px !important;border: 1px solid transparent !important;padding: 7px 15px 7px 10px !important;font-size: 20px !important;letter-spacing:0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;font-family:'Arial', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#000000 !important;}</style><link href="https://fonts.googleapis.com/css?family=Arial" rel="stylesheet">

   <script>
    var evalHandler =
        (cm) => {
            fetch('#{window.location.href}eval-tla-expression',
                  {method: 'POST',
                   mode: 'cors',
                   body: JSON.stringify({'input': cm.getValue()}),
                   headers: new Headers({'accept': 'application/json',
                                         'content-type': 'application/json'})})
                .then(response => response.json())
                .then(
                    function(data) {
                        resultBlock = cm.getWrapperElement().parentNode.querySelector("#result");
                        if('data' in data) {
                            resultBlock.style.color = "#333333";
                            resultBlock.innerHTML = data.data;
                        }
                        else {
                            resultBlock.style.color = "#cc0000";
                            resultBlock.innerHTML = data.error.message;
                        }
                    })
                .catch(error => console.log(error))
        };

    var addNewCm = function () {
        var isInitial = false;
        var cm = CodeMirror(function(elt) {
            identifier = Math.random().toString(36).substring(7);
            placeholder = document.getElementById("code-and-result");
            // if the placeholder identifier is initial, does not need to clone it
            if (placeholder.children[0].id != "initial")
                placeholder = document.body.appendChild(placeholder.cloneNode(true));
            else
                isInitial = true;
            placeholder.children[0].outerHTML = `<div id="${identifier}"></div>`;
            placeholder.children[1].outerHTML = `<div id="result" style="margin-left: 10px; font-size: 85%; align-self: center; font-family: monospace;"></div>`;
            placeholder = document.getElementById(identifier);
            placeholder.parentNode.replaceChild(elt, placeholder);
        }, {
            mode: 'ruby',
            viewportMargin: Infinity,
            extraKeys: {
                'Shift-Enter': evalHandler,
                'Ctrl-Enter': evalHandler,
                'Alt-Enter': (cm) => addNewCm()
            },
        });

        cm.setSize("50%", "auto");
        cm.focus();
        cm.setOption("autoCloseBrackets", true);

        if(!isInitial)
            cm.on("beforeChange", function(cm, event) {
                if(cm.getValue() == "" && event.to.line == 0 && event.to.ch == 0 && event.origin == "+delete"){
                    el = cm.getWrapperElement().parentNode;
                    console.log(el);
                    el.previousElementSibling.children[0].CodeMirror.focus();
                    el.remove();
                }
            });
    };

    document.addEventListener("DOMContentLoaded", function(event) {
       addNewCm()
    });
    </script>

   <div style="display: flex">
     <div style="display: flex; justify-content:flex-start; width:100%; padding:10px 15px 7px 10px; font-size: 12px; color: #666666">
       <b>Guima&nbsp;</b>
       | A TLA+ REPL
     </div>
     <div style="display: flex; justify-content:flex-end; width:100%; padding:0;">
       <a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/pfeodrippe" style="transform: scale(0.5);">
         <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy me a coffee">
         <span style="margin-left:5px;font-size:19px !important;">Buy me a coffee</span>
       </a>
     </div>
   </div>

   <div id="code-and-result" style="display: flex; margin-top: 10px;">
     <div id="initial"></div>
    <div></div>
    </div>
  </div>

</body>
