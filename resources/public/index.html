<body style="background-color: #EEEEEE">
  <script src="vendors/codemirror/lib/codemirror.js"></script>
  <link rel="stylesheet" href="vendors/codemirror/lib/codemirror.css">
  <script src="vendors/codemirror/mode/ruby/ruby.js"></script>

   <script>
    var evalHandler =
        (cm) => {
            fetch('http://localhost:8080/eval-tla-expression',
                  {method: 'POST',
                   mode: 'cors',
                   body: JSON.stringify({'input': cm.getValue()}),
                   headers: new Headers({'accept': 'application/json',
                                         'content-type': 'application/json'})})
                .then(response => response.json())
                .then(
                    function(data) {
                        resultBlock = cm.getWrapperElement().parentNode.querySelector("#result");
                        if('data' in data) {
                            resultBlock.style.color = "#333333";
                            resultBlock.innerHTML = data.data;
                        }
                        else {
                            resultBlock.style.color = "#cc0000";
                            resultBlock.innerHTML = data.error.message;
                        }
                    })
                .catch(error => console.log(error))
        };

    var addNewCm = function () {
        var isInitial = false;
        var cm = CodeMirror(function(elt) {
            identifier = Math.random().toString(36).substring(7);
            placeholder = document.getElementById("code-and-result");
            // if the placeholder identifier is initial, does not need to clone it
            if (placeholder.children[0].id != "initial")
                placeholder = document.body.appendChild(placeholder.cloneNode(true));
            else
                isInitial = true;
            placeholder.children[0].outerHTML = `<div id="${identifier}"></div>`;
            placeholder.children[1].outerHTML = `<div id="result" style="margin-left: 10px; font-size: 95%;"></div>`;
            placeholder = document.getElementById(identifier);
            placeholder.parentNode.replaceChild(elt, placeholder);
        }, {
            mode: 'ruby',
            viewportMargin: Infinity,
            extraKeys: {
                'Shift-Enter': evalHandler,
                'Ctrl-Enter': evalHandler,
                'Alt-Enter': (cm) => addNewCm()
            },
        });

        cm.setSize("50%", "auto");

        cm.focus();

        if(!isInitial)
            cm.on("beforeChange", function(cm, event) {
                if(cm.getValue() == "" && event.to.line == 0 && event.to.ch == 0 && event.origin == "+delete"){
                    el = cm.getWrapperElement().parentNode;
                    console.log(el);
                    el.previousElementSibling.children[0].CodeMirror.focus();
                    el.remove();
                }
            });
    };

    document.addEventListener("DOMContentLoaded", function(event) {
       addNewCm()
    });
  </script>

  <div id="code-and-result" style="display: flex; margin-top: 40px;">
    <div id="initial"></div>
    <div></div>
    </div>
  </div>

</body>
